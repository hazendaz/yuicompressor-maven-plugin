<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>YuiCompressorMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">yuicompressor-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">net.alchim31.maven.yuicompressor</a> &gt; <span class="el_source">YuiCompressorMojo.java</span></div><h1>YuiCompressorMojo.java</h1><pre class="source lang-java linenums">/*
 * YuiCompressor Maven plugin
 *
 * Copyright 2012-2025 Hazendaz.
 *
 * Licensed under the GNU Lesser General Public License (LGPL),
 * version 2.1 or later (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 * You may read the licence in the 'lgpl.txt' file in the root folder of
 * project or obtain a copy at
 *
 *     https://www.gnu.org/licenses/lgpl-2.1.html
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package net.alchim31.maven.yuicompressor;

import com.yahoo.platform.yui.compressor.CssCompressor;
import com.yahoo.platform.yui.compressor.JavaScriptCompressor;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Collection;
import java.util.HashSet;
import java.util.Locale;
import java.util.Set;
import java.util.zip.GZIPOutputStream;

import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.codehaus.plexus.util.FileUtils;
import org.codehaus.plexus.util.IOUtil;

/**
 * Apply compression on JS and CSS (using YUI Compressor).
 */
@Mojo(name = &quot;compress&quot;, defaultPhase = LifecyclePhase.PROCESS_RESOURCES, requiresProject = true, threadSafe = true)
<span class="nc" id="L50">public class YuiCompressorMojo extends MojoSupport {</span>

    /**
     * Read the input file using &quot;encoding&quot;.
     */
    @Parameter(defaultValue = &quot;${project.build.sourceEncoding}&quot;, property = &quot;file.encoding&quot;)
    private String encoding;

    /**
     * The output filename suffix.
     */
    @Parameter(defaultValue = &quot;-min&quot;, property = &quot;maven.yuicompressor.suffix&quot;)
    private String suffix;

    /**
     * If no &quot;suffix&quot; must be add to output filename (maven's configuration manage empty suffix like default).
     */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.nosuffix&quot;)
    private boolean nosuffix;

    /**
     * Insert line breaks in output after the specified column number.
     */
    @Parameter(defaultValue = &quot;-1&quot;, property = &quot;maven.yuicompressor.linebreakpos&quot;)
    private int linebreakpos;

    /** [js only] No compression. */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.nocompress&quot;)
    private boolean nocompress;

    /**
     * [js only] Minify only, do not obfuscate.
     */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.nomunge&quot;)
    private boolean nomunge;

    /**
     * [js only] Preserve unnecessary semicolons.
     */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.preserveAllSemiColons&quot;)
    private boolean preserveAllSemiColons;

    /**
     * [js only] disable all micro optimizations.
     */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.disableOptimizations&quot;)
    private boolean disableOptimizations;

    /**
     * force the compression of every files, else if compressed file already exists and is younger than source file,
     * nothing is done.
     */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.force&quot;)
    private boolean force;

    /**
     * a list of aggregation/concatenation to do after processing, for example to create big js files that contain
     * several small js files. Aggregation could be done on any type of file (js, css, ..).
     */
    @Parameter
    private Aggregation[] aggregations;

    /**
     * request to create a gzipped version of the yuicompressed/aggregation files.
     */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.gzip&quot;)
    private boolean gzip;

    /** gzip level. */
    @Parameter(defaultValue = &quot;9&quot;, property = &quot;maven.yuicompressor.level&quot;)
    private int level;

    /**
     * show statistics (compression ratio).
     */
    @Parameter(defaultValue = &quot;true&quot;, property = &quot;maven.yuicompressor.statistics&quot;)
    private boolean statistics;

    /** aggregate files before minify. */
    @Parameter(defaultValue = &quot;false&quot;, property = &quot;maven.yuicompressor.preProcessAggregates&quot;)
    private boolean preProcessAggregates;

    /** use the input file as output when the compressed file is larger than the original. */
    @Parameter(defaultValue = &quot;true&quot;, property = &quot;maven.yuicompressor.useSmallestFile&quot;)
    private boolean useSmallestFile;

    /** The in size total. */
    private long inSizeTotal;

    /** The out size total. */
    private long outSizeTotal;

    /** Keep track of updated files for aggregation on incremental builds. */
    private Set&lt;String&gt; incrementalFiles;

    @Override
    protected String[] getDefaultIncludes() {
<span class="nc" id="L147">        return new String[] { &quot;**/*.css&quot;, &quot;**/*.js&quot; };</span>
    }

    @Override
    public void beforeProcess() throws IOException {
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (nosuffix) {</span>
<span class="nc" id="L153">            suffix = &quot;&quot;;</span>
        }

<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (preProcessAggregates) {</span>
<span class="nc" id="L157">            aggregate();</span>
        }
<span class="nc" id="L159">    }</span>

    @Override
    protected void afterProcess() throws IOException {
<span class="nc bnc" id="L163" title="All 4 branches missed.">        if (statistics &amp;&amp; inSizeTotal &gt; 0) {</span>
<span class="nc" id="L164">            getLog().info(String.format(&quot;total input (%db) -&gt; output (%db)[%d%%]&quot;, inSizeTotal, outSizeTotal,</span>
<span class="nc" id="L165">                    outSizeTotal * 100 / inSizeTotal));</span>
        }

<span class="nc bnc" id="L168" title="All 2 branches missed.">        if (!preProcessAggregates) {</span>
<span class="nc" id="L169">            aggregate();</span>
        }
<span class="nc" id="L171">    }</span>

    /**
     * Aggregate.
     *
     * @throws IOException
     *             the IO exception
     */
    private void aggregate() throws IOException {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (aggregations == null) {</span>
<span class="nc" id="L181">            return;</span>
        }

<span class="nc" id="L184">        Set&lt;File&gt; previouslyIncludedFiles = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        for (Aggregation aggregation : aggregations) {</span>
<span class="nc" id="L186">            getLog().info(&quot;generate aggregation : &quot; + aggregation.getOutput());</span>
<span class="nc" id="L187">            Collection&lt;File&gt; aggregatedFiles = aggregation.run(previouslyIncludedFiles, buildContext, incrementalFiles);</span>
<span class="nc" id="L188">            previouslyIncludedFiles.addAll(aggregatedFiles);</span>

<span class="nc" id="L190">            File gzipped = gzipIfRequested(aggregation.getOutput());</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">            if (statistics) {</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                if (gzipped != null) {</span>
<span class="nc" id="L193">                    getLog().info(String.format(&quot;%s (%db) -&gt; %s (%db)[%d%%]&quot;, aggregation.getOutput().getName(),</span>
<span class="nc" id="L194">                            aggregation.getOutput().length(), gzipped.getName(), gzipped.length(),</span>
<span class="nc" id="L195">                            ratioOfSize(aggregation.getOutput(), gzipped)));</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">                } else if (aggregation.getOutput().exists()) {</span>
<span class="nc" id="L197">                    getLog().info(String.format(&quot;%s (%db)&quot;, aggregation.getOutput().getName(),</span>
<span class="nc" id="L198">                            aggregation.getOutput().length()));</span>
                } else {
<span class="nc" id="L200">                    getLog().warn(String.format(&quot;%s not created&quot;, aggregation.getOutput().getName()));</span>
                }
            }
        }
<span class="nc" id="L204">    }</span>

    @Override
    protected void processFile(SourceFile src) throws IOException, MojoExecutionException {
<span class="nc" id="L208">        File inFile = src.toFile();</span>
<span class="nc" id="L209">        getLog().debug(&quot;on incremental build only compress if input file has Delta&quot;);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (buildContext.isIncremental()) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (!buildContext.hasDelta(inFile)) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                if (getLog().isInfoEnabled()) {</span>
<span class="nc" id="L213">                    getLog().info(&quot;nothing to do, &quot; + inFile + &quot; has no Delta&quot;);</span>
                }
<span class="nc" id="L215">                return;</span>
            }
<span class="nc bnc" id="L217" title="All 2 branches missed.">            if (incrementalFiles == null) {</span>
<span class="nc" id="L218">                incrementalFiles = new HashSet&lt;&gt;();</span>
            }
        }

<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (getLog().isDebugEnabled()) {</span>
<span class="nc" id="L223">            getLog().debug(&quot;compress file :&quot; + src.toFile() + &quot; to &quot; + src.toDestFile(suffix));</span>
        }

<span class="nc" id="L226">        File outFile = src.toDestFile(suffix);</span>
<span class="nc bnc" id="L227" title="All 4 branches missed.">        if (!nosuffix &amp;&amp; isMinifiedFile(inFile)) {</span>
<span class="nc" id="L228">            return;</span>
        }
<span class="nc" id="L230">        getLog().debug(&quot;only compress if input file is younger than existing output file&quot;);</span>
<span class="nc bnc" id="L231" title="All 6 branches missed.">        if (!force &amp;&amp; outFile.exists() &amp;&amp; outFile.lastModified() &gt; inFile.lastModified()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (getLog().isInfoEnabled()) {</span>
<span class="nc" id="L233">                getLog().info(&quot;nothing to do, &quot; + outFile</span>
                        + &quot; is younger than original, use 'force' option or clean your target&quot;);
            }
<span class="nc" id="L236">            return;</span>
        }
<span class="nc" id="L238">        File outFileTmp = Path.of(outFile.getCanonicalPath() + &quot;.tmp&quot;).toFile();</span>
<span class="nc" id="L239">        FileUtils.forceDelete(outFileTmp);</span>

<span class="nc bnc" id="L241" title="All 4 branches missed.">        if (!outFile.getParentFile().exists() &amp;&amp; !outFile.getParentFile().mkdirs()) {</span>
<span class="nc" id="L242">            throw new MojoExecutionException(&quot;Cannot create resource output directory: &quot; + outFile.getParentFile());</span>
        }
<span class="nc" id="L244">        getLog().debug(&quot;use a temporary outputfile (in case in == out)&quot;);</span>

<span class="nc" id="L246">        try (InputStreamReader in = new InputStreamReader(Files.newInputStream(inFile.toPath()),</span>
<span class="nc" id="L247">                Charset.forName(encoding));</span>
                /* outFileTmp will be deleted create with FileOutputStream */
<span class="nc" id="L249">                OutputStreamWriter out = new OutputStreamWriter(Files.newOutputStream(outFileTmp.toPath()),</span>
<span class="nc" id="L250">                        Charset.forName(encoding));) {</span>

<span class="nc" id="L252">            getLog().debug(&quot;start compression&quot;);</span>
            try {
<span class="nc bnc" id="L254" title="All 2 branches missed.">                if (nocompress) {</span>
<span class="nc" id="L255">                    getLog().info(&quot;No compression is enabled&quot;);</span>
<span class="nc" id="L256">                    IOUtil.copy(in, out);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                } else if (&quot;.js&quot;.equalsIgnoreCase(src.getExtension())) {</span>
<span class="nc" id="L258">                    JavaScriptCompressor compressor = new JavaScriptCompressor(in, jsErrorReporter);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">                    compressor.compress(out, linebreakpos, !nomunge, jswarn, preserveAllSemiColons,</span>
                            disableOptimizations);
<span class="nc bnc" id="L261" title="All 2 branches missed.">                } else if (&quot;.css&quot;.equalsIgnoreCase(src.getExtension())) {</span>
<span class="nc" id="L262">                    compressCss(in, out);</span>
                }
<span class="nc" id="L264">            } catch (IndexOutOfBoundsException e) {</span>
                // This catch exists to not fail the build on YUICompressor bugs.
                // 2.4.8 seems to have issue on windows : https://github.com/yui/yuicompressor/issues/78
                // 2.4.8 failed to process empty file (demo01) : https://github.com/yui/yuicompressor/issues/130
<span class="nc" id="L268">                getLog().warn(&quot;YUICompressor failed on file: &quot; + inFile.getName()</span>
                        + &quot; due to IndexOutOfBoundsException. Skipping this file.&quot;);
<span class="nc" id="L270">                return;</span>
<span class="nc" id="L271">            }</span>
<span class="nc" id="L272">            getLog().debug(&quot;end compression&quot;);</span>
<span class="nc" id="L273">        }</span>

<span class="nc bnc" id="L275" title="All 4 branches missed.">        boolean outputIgnored = useSmallestFile &amp;&amp; inFile.length() &lt; outFile.length();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (outputIgnored) {</span>
<span class="nc" id="L277">            FileUtils.forceDelete(outFileTmp);</span>
<span class="nc" id="L278">            FileUtils.copyFile(inFile, outFile);</span>
<span class="nc" id="L279">            getLog().debug(&quot;output greater than input, using original instead&quot;);</span>
        } else {
<span class="nc" id="L281">            FileUtils.forceDelete(outFile);</span>
<span class="nc" id="L282">            FileUtils.rename(outFileTmp, outFile);</span>
<span class="nc" id="L283">            buildContext.refresh(outFile);</span>
        }

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (buildContext.isIncremental()) {</span>
<span class="nc" id="L287">            incrementalFiles.add(outFile.getCanonicalPath());</span>
        }

<span class="nc" id="L290">        File gzipped = gzipIfRequested(outFile);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (statistics) {</span>
<span class="nc" id="L292">            inSizeTotal += inFile.length();</span>
<span class="nc" id="L293">            outSizeTotal += outFile.length();</span>

            String fileStatistics;
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if (outputIgnored) {</span>
<span class="nc" id="L297">                fileStatistics = String.format(</span>
<span class="nc" id="L298">                        &quot;%s (%db) -&gt; %s (%db)[compressed output discarded (exceeded input size)]&quot;, inFile.getName(),</span>
<span class="nc" id="L299">                        inFile.length(), outFile.getName(), outFile.length());</span>
            } else {
<span class="nc" id="L301">                fileStatistics = String.format(&quot;%s (%db) -&gt; %s (%db)[%d%%]&quot;, inFile.getName(), inFile.length(),</span>
<span class="nc" id="L302">                        outFile.getName(), outFile.length(), ratioOfSize(inFile, outFile));</span>
            }

<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (gzipped != null) {</span>
<span class="nc" id="L306">                fileStatistics = fileStatistics + String.format(&quot; -&gt; %s (%db)[%d%%]&quot;, gzipped.getName(),</span>
<span class="nc" id="L307">                        gzipped.length(), ratioOfSize(inFile, gzipped));</span>
            }
<span class="nc" id="L309">            getLog().info(fileStatistics);</span>
        }
<span class="nc" id="L311">    }</span>

    /**
     * Compress css.
     *
     * @param in
     *            the in
     * @param out
     *            the out
     */
    private void compressCss(InputStreamReader in, OutputStreamWriter out) throws IOException {
        try {
<span class="nc" id="L323">            CssCompressor compressor = new CssCompressor(in);</span>
<span class="nc" id="L324">            compressor.compress(out, linebreakpos);</span>
<span class="nc" id="L325">        } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L326">            throw new IllegalArgumentException(</span>
                    &quot;Unexpected characters found in CSS file. Ensure that the CSS file does not contain '$', and try again&quot;,
                    e);
<span class="nc" id="L329">        }</span>
<span class="nc" id="L330">    }</span>

    /**
     * Gzip if requested.
     *
     * @param file
     *            the file
     *
     * @return the file
     *
     * @throws IOException
     *             the IO exception
     */
    protected File gzipIfRequested(File file) throws IOException {
<span class="nc bnc" id="L344" title="All 8 branches missed.">        if (!gzip || file == null || !file.exists() || &quot;.gz&quot;.equalsIgnoreCase(FileUtils.getExtension(file.getName()))) {</span>
<span class="nc" id="L345">            return null;</span>
        }
<span class="nc" id="L347">        File gzipped = Path.of(file.getCanonicalFile() + &quot;.gz&quot;).toFile();</span>
<span class="nc" id="L348">        getLog().debug(String.format(&quot;create gzip version : %s&quot;, gzipped.getName()));</span>
<span class="nc" id="L349">        try (InputStream in = Files.newInputStream(file.toPath());</span>
<span class="nc" id="L350">                GZIPOutputStream out = new GZIPOutputStream(buildContext.newFileOutputStream(gzipped)) {</span>
                    {
<span class="nc" id="L352">                        def.setLevel(level);</span>
                    }
                };) {
<span class="nc" id="L355">            IOUtil.copy(in, out);</span>
        }
<span class="nc" id="L357">        return gzipped;</span>
    }

    /**
     * Ratio of size.
     *
     * @param file100
     *            the file 100
     * @param fileX
     *            the file X
     *
     * @return the long
     */
    protected long ratioOfSize(File file100, File fileX) {
<span class="nc" id="L371">        long v100 = Math.max(file100.length(), 1);</span>
<span class="nc" id="L372">        long vX = Math.max(fileX.length(), 1);</span>
<span class="nc" id="L373">        return vX * 100 / v100;</span>
    }

    /**
     * Checks if is minified file.
     *
     * @param inFile
     *            the in file
     *
     * @return true, if is minified file
     */
    private boolean isMinifiedFile(File inFile) {
<span class="nc" id="L385">        String filename = inFile.getName().toLowerCase(Locale.getDefault());</span>
<span class="nc bnc" id="L386" title="All 4 branches missed.">        return filename.endsWith(suffix + &quot;.js&quot;) || filename.endsWith(suffix + &quot;.css&quot;);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>